import pandas as pd
import re

def load_translation_dictionary(excel_file):
    """Load the Excel file and create bidirectional translation dictionaries"""
    df = pd.read_excel(excel_file)
    
    # Initialize dictionaries
    eng_to_fl = {}
    fl_to_eng = {}
    
    for _, row in df.iterrows():
        eng = row['English'].lower()
        fl = row['FL'].lower()
        
        # Add primary translations
        eng_to_fl[eng] = fl
        fl_to_eng[fl] = eng
        
        # Add alternative FL translations if they exist
        if pd.notna(row['FL_Alt']):
            for alt_fl in row['FL_Alt'].split(', '):
                fl_to_eng[alt_fl.lower()] = eng
        
        # Add alternative English translations if they exist
        if pd.notna(row['English_Alt']):
            for alt_eng in row['English_Alt'].split(', '):
                eng_to_fl[alt_eng.lower()] = fl
    
    return eng_to_fl, fl_to_eng

def translate_text(text, direction='eng_to_fl', dictionary_file='translation_master.xlsx', mark_unknown=True):
    """
    Translate text between English and FL
    
    Parameters:
    - text: Input text to translate
    - direction: 'eng_to_fl' or 'fl_to_eng'
    - dictionary_file: Excel file containing translations
    - mark_unknown: If True, marks unknown words with brackets; if False, leaves them unchanged
    """
    # Load dictionaries
    eng_to_fl, fl_to_eng = load_translation_dictionary(dictionary_file)
    
    # Choose dictionary based on direction
    dictionary = eng_to_fl if direction == 'eng_to_fl' else fl_to_eng
    
    # Split text into words
    words = re.findall(r'\b\w+\b', text.lower())
    
    # Prepare results
    translation = []
    unknown_words = []
    stats = {'known': 0, 'unknown': 0}
    
    # Process each word
    for word in words:
        if word in dictionary:
            translation.append(dictionary[word])
            stats['known'] += 1
        else:
            translation.append(f"[{word}?]" if mark_unknown else word)
            unknown_words.append(word)
            stats['unknown'] += 1
    
    # Prepare output
    result = {
        'original': text,
        'translated': ' '.join(translation),
        'unknown_words': unknown_words,
        'stats': stats,
        'coverage': (stats['known'] / len(words)) * 100 if words else 0
    }
    
    return result

def print_translation_result(result):
    """Pretty print the translation results"""
    print("\n=== Translation Results ===")
    print("\nOriginal text:")
    print(result['original'])
    print("\nTranslated text:")
    print(result['translated'])
    print("\nStatistics:")
    print(f"Words translated: {result['stats']['known']}")
    print(f"Unknown words: {result['stats']['unknown']}")
    print(f"Translation coverage: {result['coverage']:.1f}%")
    if result['unknown_words']:
        print("\nUnknown words:")
        print(", ".join(result['unknown_words']))

if __name__ == "__main__":
    # Example translations
    english_text = "The laser requires an output power many orders of magnitude higher"
    fl_text = "fad aynona riga yron yrisyr gwang asie dryl√∏"
    
    # Example with marked unknown words
    print("\nEnglish to FL (marking unknown words):")
    result = translate_text(english_text, 'eng_to_fl', mark_unknown=True)
    print_translation_result(result)
    
    # Example preserving unknown words
    print("\nFL to English (preserving unknown words):")
    result = translate_text(fl_text, 'fl_to_eng', mark_unknown=False)
    print_translation_result(result)
